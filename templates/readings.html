{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>Soil &amp; Environment Sensor Readings</h2>
    <p>Reading {{ reading_no }} of {{ max_readings }}</p>

    <div class="info-box">
        <ol>
            <li>Soil Nitrogen (N) – kg/ha</li>
            <li>Soil Phosphorus (P) – kg/ha</li>
            <li>Soil Potassium (K) – kg/ha</li>
            <li>Soil Electrical Conductivity (EC)</li>
            <li>Soil Temperature (°C)</li>
            <li>Soil pH</li>
            <li>Soil Moisture (%)</li>
            <li>Air Temperature (°C)</li>
            <li>Air Humidity (%)</li>
            <li>Water / Soil TDS</li>
        </ol>
    </div>

    <!-- Buttons to connect + read from ESP32 over Bluetooth -->
    <div style="margin-bottom: 1rem; display:flex; gap:0.75rem; flex-wrap:wrap;">
        <button type="button" id="btConnect" class="secondary-btn">
            Connect to Sensor (Bluetooth)
        </button>
        <button type="button" id="btRead" class="secondary-btn" disabled>
            Read values from Sensor
        </button>
        <span id="btStatus" style="align-self:center; font-size:0.9rem; color:#555;">
            Not connected
        </span>
    </div>

    <!-- The form is used only for layout; saving is done via JS (AJAX) -->
    <form class="form-grid" onsubmit="return false;">
        <label>Soil Nitrogen (N) (kg/ha)
            <input type="number" step="0.01" name="soil_n" id="soil_n" value="">
        </label>

        <label>Soil Phosphorus (P) (kg/ha)
            <input type="number" step="0.01" name="soil_p" id="soil_p" value="">
        </label>

        <label>Soil Potassium (K) (kg/ha)
            <input type="number" step="0.01" name="soil_k" id="soil_k" value="">
        </label>

        <label>Soil Electrical Conductivity (EC)
            <input type="number" step="0.01" name="ec" id="ec" value="">
        </label>

        <label>Soil Temperature (°C)
            <input type="number" step="0.1" name="soil_temp" id="soil_temp" value="">
        </label>

        <label>Soil pH
            <input type="number" step="0.01" name="ph" id="ph" value="">
        </label>

        <label>Soil Moisture (%)
            <input type="number" step="0.1" name="soil_moisture" id="soil_moisture" value="">
        </label>

        <label>Air Temperature (°C)
            <input type="number" step="0.1" name="air_temp" id="air_temp" value="">
        </label>

        <label>Air Humidity (%)
            <input type="number" step="0.1" name="air_humidity" id="air_humidity" value="">
        </label>

        <label>Water / Soil TDS
            <input type="number" step="0.1" name="tds" id="tds" value="">
        </label>

        <div class="button-row" style="margin-top:1.5rem;">
            <button type="button" id="btnSaveReading" class="primary-btn">
                Save this Reading
            </button>
            <button type="button" id="btnResetReadings" class="secondary-btn">
                Reset All Readings
            </button>
        </div>
    </form>
</div>

<script>
// ================== WEB BLUETOOTH SETUP ==================

// must match ESP32 sketch:
const SERVICE_UUID        = '12345678-1234-5678-1234-56789abcdef0';
const CHARACTERISTIC_UUID = '12345678-1234-5678-1234-56789abcdef1';

let btDevice = null;
let soilCharacteristic = null;

const btConnectBtn = document.getElementById('btConnect');
const btReadBtn    = document.getElementById('btRead');
const btStatus     = document.getElementById('btStatus');

const saveReadingUrl  = "{{ url_for('api_save_reading') }}";
const resetReadingsUrl = "{{ url_for('api_reset_readings') }}";

function setStatus(msg) {
    btStatus.textContent = msg;
}

// ---------- Bluetooth Connect ----------
btConnectBtn.addEventListener('click', async () => {
    try {
        if (!navigator.bluetooth) {
            alert("Web Bluetooth is not supported in this browser. Use Chrome or Edge.");
            return;
        }

        setStatus('Requesting Bluetooth device…');

        // Let browser show all devices, but we will select NRSC_SoilMonitor
        btDevice = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'NRSC_SoilMonitor' }],
            optionalServices: [SERVICE_UUID]
        });

        btDevice.addEventListener('gattserverdisconnected', () => {
            soilCharacteristic = null;
            btReadBtn.disabled = true;
            setStatus('Disconnected');
        });

        setStatus('Connecting…');
        const server = await btDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        soilCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        // enable READ button
        btReadBtn.disabled = false;
        setStatus('Connected. Click "Read values from Sensor".');

        // Enable notifications so ESP32 pushes latest packet
        try {
            await soilCharacteristic.startNotifications();
            soilCharacteristic.addEventListener('characteristicvaluechanged', event => {
                const value = event.target.value;
                const decoder = new TextDecoder('utf-8');
                const text = decoder.decode(value.buffer);

                console.log('BLE notify payload:', text);
                fillSensorFieldsFromCSV(text);
            });
        } catch (e) {
            console.warn('Could not start notifications, will rely on manual read:', e);
        }

    } catch (err) {
        console.error(err);
        // User closed the chooser or did not select a device
        if (err && (err.name === 'NotFoundError' || String(err.message).toLowerCase().includes('cancelled'))) {
            setStatus('Bluetooth device selection cancelled.');
            return;
        }
        alert('Bluetooth error: ' + err.message);
        setStatus('Not connected');
    }
});

// ---------- Read once (manual trigger) ----------
btReadBtn.addEventListener('click', async () => {
    if (!soilCharacteristic) {
        alert('Sensor not connected yet.');
        return;
    }

    try {
        setStatus('Reading data from sensor…');
        const value = await soilCharacteristic.readValue();
        const decoder = new TextDecoder('utf-8');
        const text = decoder.decode(value.buffer);

        console.log('BLE read payload:', text);
        fillSensorFieldsFromCSV(text);
        setStatus('Values filled from sensor. You can now click "Save this Reading".');
    } catch (err) {
        console.error(err);
        alert('Error reading from sensor: ' + err.message);
        setStatus('Read failed');
    }
});

// ---------- Helper: parse CSV and fill inputs ----------
function fillSensorFieldsFromCSV(csvText) {
    const parts = csvText.trim().split(',');

    const [
        n, p, k, ec,
        soilTemp, ph, moisture,
        airTemp, airHumidity, tds
    ] = parts;

    document.getElementById('soil_n').value        = n ?? "";
    document.getElementById('soil_p').value        = p ?? "";
    document.getElementById('soil_k').value        = k ?? "";
    document.getElementById('ec').value            = ec ?? "";
    document.getElementById('soil_temp').value     = soilTemp ?? "";
    document.getElementById('ph').value            = ph ?? "";
    document.getElementById('soil_moisture').value = moisture ?? "";
    document.getElementById('air_temp').value      = airTemp ?? "";
    document.getElementById('air_humidity').value  = airHumidity ?? "";
    document.getElementById('tds').value           = tds ?? "";
}

// ================== SAVE / RESET via AJAX ==================

const btnSave = document.getElementById('btnSaveReading');
const btnReset = document.getElementById('btnResetReadings');

btnSave.addEventListener('click', async () => {
    const payload = {
        soil_n:        document.getElementById('soil_n').value,
        soil_p:        document.getElementById('soil_p').value,
        soil_k:        document.getElementById('soil_k').value,
        ec:            document.getElementById('ec').value,
        soil_temp:     document.getElementById('soil_temp').value,
        ph:            document.getElementById('ph').value,
        soil_moisture: document.getElementById('soil_moisture').value,
        air_temp:      document.getElementById('air_temp').value,
        air_humidity:  document.getElementById('air_humidity').value,
        tds:           document.getElementById('tds').value
    };

    try {
        const resp = await fetch(saveReadingUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (!data.ok) {
            alert('Could not save reading on server.');
            return;
        }

        setStatus(`Reading saved (${data.count}/10).`);

        if (data.done) {
            // After 10th reading go to calculation
            window.location.href = "{{ url_for('calculate') }}";
        }
    } catch (err) {
        console.error(err);
        alert('Error saving reading: ' + err.message);
    }
});

btnReset.addEventListener('click', async () => {
    if (!confirm('Clear all saved readings?')) return;

    try {
        const resp = await fetch(resetReadingsUrl, { method: 'POST' });
        const data = await resp.json();
        if (!data.ok) {
            alert('Could not reset readings on server.');
            return;
        }

        // clear fields
        ['soil_n','soil_p','soil_k','ec','soil_temp','ph',
         'soil_moisture','air_temp','air_humidity','tds'].forEach(id => {
            document.getElementById(id).value = '';
        });

        setStatus('All readings cleared (0/10).');
    } catch (err) {
        console.error(err);
        alert('Error resetting readings: ' + err.message);
    }
});
</script>
{% endblock %}
