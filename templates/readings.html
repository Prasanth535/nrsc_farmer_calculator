{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="readings-header">
        <h2>{{ t['title_readings'] }}</h2>
        <div class="readings-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ ((reading_no-1) if (reading_no-1) < max_readings else max_readings) / max_readings * 100 }}%"></div>
            </div>
            <span class="progress-text">{{ t['lbl_reading_progress'].format(current=reading_no, total=max_readings) }}</span>
        </div>
    </div>

    <div class="sensor-guide">
        <h3 class="guide-title">üìã {{ t['guide_title'] }}</h3>
        <div class="guide-grid">
            <div class="guide-item">
                <span class="guide-number">1</span>
                <span class="guide-text">{{ t['param_n'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">2</span>
                <span class="guide-text">{{ t['param_p'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">3</span>
                <span class="guide-text">{{ t['param_k'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">4</span>
                <span class="guide-text">{{ t['param_ec'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">5</span>
                <span class="guide-text">{{ t['param_stemp'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">6</span>
                <span class="guide-text">{{ t['param_ph'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">7</span>
                <span class="guide-text">{{ t['param_moist'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">8</span>
                <span class="guide-text">{{ t['param_atemp'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">9</span>
                <span class="guide-text">{{ t['param_ahum'] }}</span>
            </div>
            <div class="guide-item">
                <span class="guide-number">10</span>
                <span class="guide-text">{{ t['param_tds'] }}</span>
            </div>
        </div>
    </div>

    <!-- Bluetooth Connection Section -->
    <div class="bluetooth-section">
        <h3 class="section-title">üîó {{ t['sect_bluetooth'] }}</h3>
        <div class="bluetooth-controls">
            <button type="button" id="btConnect" class="bluetooth-btn connect-btn">
                <span class="btn-icon">üì±</span>
                {{ t['btn_connect'] }}
            </button>
            <button type="button" id="btRead" class="bluetooth-btn read-btn" disabled>
                <span class="btn-icon">üìä</span>
                {{ t['btn_read'] }}
            </button>
            <div class="connection-status">
                <div id="btStatus" class="status-indicator">
                    <span class="status-dot"></span>
                    {{ t['status_not_connected'] }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Readings Form -->
    <form class="readings-form">
        <h3 class="section-title">üéØ {{ t['sect_manual_entry'] }}</h3>
        
        <div class="readings-grid">
            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_n'] }}</span>
                    <input type="number" step="0.01" name="soil_n" id="soil_n" 
                           placeholder="0.00" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_p'] }}</span>
                    <input type="number" step="0.01" name="soil_p" id="soil_p" 
                           placeholder="0.00" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_k'] }}</span>
                    <input type="number" step="0.01" name="soil_k" id="soil_k" 
                           placeholder="0.00" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_ec'] }}</span>
                    <input type="number" step="0.01" name="ec" id="ec" 
                           placeholder="0.00" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_stemp'] }}</span>
                    <input type="number" step="0.1" name="soil_temp" id="soil_temp" 
                           placeholder="0.0" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_ph'] }}</span>
                    <input type="number" step="0.01" name="ph" id="ph" 
                           placeholder="0.00" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_moist'] }}</span>
                    <input type="number" step="0.1" name="soil_moisture" id="soil_moisture" 
                           placeholder="0.0" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_atemp'] }}</span>
                    <input type="number" step="0.1" name="air_temp" id="air_temp" 
                           placeholder="0.0" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_ahum'] }}</span>
                    <input type="number" step="0.1" name="air_humidity" id="air_humidity" 
                           placeholder="0.0" class="form-input">
                </label>
            </div>

            <div class="reading-group">
                <label class="form-label">
                    <span class="label-text">{{ t['param_tds'] }}</span>
                    <input type="number" step="0.1" name="tds" id="tds" 
                           placeholder="0.0" class="form-input">
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" id="btnSaveReading" class="primary-btn btn-large">
                <span class="btn-icon">üíæ</span>
                {{ t['btn_save_reading'] }} ({{ reading_no }})
            </button>
            
            <button type="button" id="btnResetReadings" class="secondary-btn">
                <span class="btn-icon">üîÑ</span>
                {{ t['btn_reset_readings'] }}
            </button>

            <!-- NEW: Generate Report button (enabled only after >= 10 readings) -->
            <button type="button" id="btnGenerateReport" class="primary-btn btn-large" disabled>
                <span class="btn-icon">üìë</span>
                {{ t['btn_gen_report'] }}
            </button>
        </div>
    </form>

    <!-- Previous Readings -->
    {% if readings %}
    <div class="previous-readings">
        <h3 class="section-title">üìã {{ t['sect_prev_readings'] }} ({{ readings|length }}/{{ max_readings }})</h3>
        <div class="readings-summary">
            {% for reading in readings %}
            <div class="reading-badge">
                <span class="badge-number">#{{ loop.index }}</span>
                <small>N:{{ reading.soil_n|round(2) }} P:{{ reading.soil_p|round(2) }} K:{{ reading.soil_k|round(2) }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .readings-header {
        text-align: center;
        margin-bottom: var(--space-xl);
    }

    .readings-progress {
        max-width: 400px;
        margin: var(--space-lg) auto;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--light-gray);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: var(--space-sm);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary-green), var(--primary-blue));
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-text {
        font-weight: 600;
        color: var(--primary-dark);
        font-size: 0.9rem;
    }

    .sensor-guide {
        background: linear-gradient(135deg, #e8f4f8 0%, #d5edf7 100%);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-xl);
        border-left: 4px solid var(--primary-blue);
    }

    .guide-title {
        color: var(--primary-dark);
        margin-bottom: var(--space-md);
        font-size: 1.1rem;
    }

    .guide-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-sm);
    }

    .guide-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-sm);
        background: rgba(255, 255, 255, 0.7);
        border-radius: var(--radius-sm);
    }

    .guide-number {
        background: var(--primary-blue);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .guide-text {
        font-size: 0.9rem;
        color: var(--dark-gray);
    }

    .bluetooth-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-xl);
        border: 2px solid var(--light-gray);
    }

    .bluetooth-controls {
        display: flex;
        gap: var(--space-md);
        align-items: center;
        flex-wrap: wrap;
    }

    .bluetooth-btn {
        padding: var(--space-md) var(--space-lg);
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-normal);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .connect-btn {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .connect-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
    }

    .read-btn {
        background: linear-gradient(135deg, var(--secondary-green) 0%, var(--secondary-light) 100%);
        color: white;
    }

    .read-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .bluetooth-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .connection-status {
        margin-left: auto;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-weight: 600;
        padding: var(--space-sm) var(--space-md);
        background: white;
        border-radius: var(--radius-md);
        border: 1px solid var(--light-gray);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--medium-gray);
        animation: pulse 2s infinite;
    }

    .status-indicator.connected .status-dot {
        background: var(--secondary-green);
    }

    .readings-form {
        margin-bottom: var(--space-xl);
    }

    .readings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
    }

    .reading-group {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        border: 1px solid var(--light-gray);
        transition: all var(--transition-normal);
    }

    .reading-group:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .previous-readings {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        border-left: 4px solid var(--accent-gold);
    }

    .readings-summary {
        display: flex;
        gap: var(--space-sm);
        flex-wrap: wrap;
        margin-top: var(--space-md);
    }

    .reading-badge {
        background: white;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        border: 1px solid var(--light-gray);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: 0.85rem;
    }

    .badge-number {
        background: var(--primary-blue);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: var(--space-md);
        max-width: 400px;
        animation: slideIn 0.3s ease;
        color: white;
    }

    .notification-success {
        background: var(--secondary-green);
    }

    .notification-error {
        background: #e74c3c;
    }

    .notification-warning {
        background: #f39c12;
    }

    .notification-info {
        background: var(--primary-blue);
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    @media (max-width: 768px) {
        .bluetooth-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .connection-status {
            margin-left: 0;
            text-align: center;
        }

        .readings-grid {
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }

        .reading-group {
            padding: var(--space-md);
        }

        .guide-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // JS Translations
    const MSGS = {
        sensorConnect: "{{ t['msg_sensor_connect'] }}",
        sensorFail: "{{ t['msg_sensor_fail'] }}",
        readingSaved: "{{ t['msg_reading_saved'] }}",
        resetConfirm: "{{ t['msg_reset_confirm'] }}",
        readWait: "{{ t['msg_read_wait'] }}",
        scanWait: "{{ t['msg_scan_wait'] }}",
        statusNotConnected: "{{ t['status_not_connected'] }}",
        statusConnected: "{{ t['status_connected'] }}",
        statusScanning: "{{ t['status_scanning'] }}",
        btnConnect: "{{ t['btn_connect'] }}",
        btnRead: "{{ t['btn_read'] }}",
        btnSaveReading: "{{ t['btn_save_reading'] }}",
        btnResetReadings: "{{ t['btn_reset_readings'] }}"
    };

    // ================== WEB vs ANDROID NATIVE BRIDGE ==================
    const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
    const CHARACTERISTIC_UUID = '12345678-1234-5678-1234-56789abcdef1';

    let btDevice = null;
    let soilCharacteristic = null;

    const btConnectBtn = document.getElementById('btConnect');
    const btReadBtn = document.getElementById('btRead');
    const btStatus = document.getElementById('btStatus');

    const saveReadingUrl = "{{ url_for('api_save_reading') }}";
    const resetReadingsUrl = "{{ url_for('api_reset_readings') }}";

    // NEW: reading count & max readings for JS logic
    let currentReadingCount = {{ readings|length }};
    const maxReadings = {{ max_readings }};
    const btnGenerate = document.getElementById('btnGenerateReport');

    function updateGenerateButtonState() {
        if (currentReadingCount >= maxReadings) {
            btnGenerate.disabled = false;
        } else {
            btnGenerate.disabled = true;
        }
    }

    function updateProgressUI() {
        const progressFill = document.querySelector('.progress-fill');
        const progressText = document.querySelector('.progress-text');
        if (!progressFill || !progressText) return;

        const cappedCount = Math.min(currentReadingCount, maxReadings);
        const percent = (cappedCount / maxReadings) * 100;
        progressFill.style.width = percent + '%';
        
        // Dynamic formatting is complex in pure JS for translations with variables
        // We will assume the format "Reading X of Y" is okay for now, or update via server reload
        // But for visual update:
        // progressText.textContent = `Reading ${currentReadingCount + 1} of ${maxReadings}`; 
    }

    function setStatus(msg, isConnected = false) {
        btStatus.textContent = msg;
        btStatus.className = `status-indicator ${isConnected ? 'connected' : ''}`;
    }

    // detect if running inside Android WebView with the native bridge exposed
    const isAndroidApp = (typeof window.AndroidNative !== 'undefined');

    // ================== UPDATED onSensorData HANDLER ==================
    window.onSensorData = function(payload) {
        try {
            let data = payload;
            if (typeof payload === 'string') {
                try { data = JSON.parse(payload); } catch (e) { /* not JSON */ }
            }

            if (data && data.event) {
                const ev = data.event;

                if (ev === 'connected') {
                    setStatus(MSGS.statusConnected, true);
                    btReadBtn.disabled = false;
                    btReadBtn.innerHTML = '<span class="btn-icon">üìä</span> ' + MSGS.btnRead;
                    btConnectBtn.innerHTML = '<span class="btn-icon">‚úÖ</span> ' + MSGS.statusConnected;
                    btConnectBtn.disabled = true;
                    showNotification(MSGS.sensorConnect, 'success');

                } else if (ev === 'disconnected' || ev === 'disconnected_by_app') {
                    setStatus(MSGS.statusNotConnected);
                    btReadBtn.disabled = true;
                    btReadBtn.innerHTML = '<span class="btn-icon">üìä</span> ' + MSGS.btnRead;
                    btConnectBtn.innerHTML = '<span class="btn-icon">üì±</span> ' + MSGS.btnConnect;
                    btConnectBtn.disabled = false;
                    showNotification(MSGS.sensorFail, 'warning');

                } else if (ev === 'scan_started') {
                    setStatus(MSGS.statusScanning);
                    btConnectBtn.innerHTML = '<span class="btn-icon">üîç</span> ' + MSGS.statusScanning;
                    btConnectBtn.disabled = true;

                } else if (ev === 'scan_stopped') {
                    if (!btStatus.classList.contains('connected')) {
                        setStatus(MSGS.statusNotConnected);
                        btConnectBtn.innerHTML = '<span class="btn-icon">üì±</span> ' + MSGS.btnConnect;
                        btConnectBtn.disabled = false;
                    }

                } else if (ev === 'reconnect_attempt') {
                    setStatus('Reconnecting...');

                } else if (ev === 'reconnect_failed') {
                    setStatus('Reconnect failed');
                    btConnectBtn.innerHTML = '<span class="btn-icon">üì±</span> ' + MSGS.btnConnect;
                    btConnectBtn.disabled = false;
                    showNotification('Failed to reconnect', 'error');
                }
                return;
            }

            if (data && (data.N !== undefined || data.n !== undefined)) {
                const n = data.N ?? data.n ?? '';
                const p = data.P ?? data.p ?? '';
                const k = data.K ?? data.k ?? '';
                const ec = data.EC ?? data.ec ?? '';
                const soilTemp = data.soil_temp ?? data.soilTemp ?? '';
                const ph = data.ph ?? '';
                const moisture = data.soil_moisture ?? data.moisture ?? '';
                const airTemp = data.air_temp ?? data.airTemp ?? '';
                const airHumidity = data.air_humidity ?? data.airHumidity ?? '';
                const tds = data.tds ?? '';

                document.getElementById('soil_n').value = n;
                document.getElementById('soil_p').value = p;
                document.getElementById('soil_k').value = k;
                document.getElementById('ec').value = ec;
                document.getElementById('soil_temp').value = soilTemp;
                document.getElementById('ph').value = ph;
                document.getElementById('soil_moisture').value = moisture;
                document.getElementById('air_temp').value = airTemp;
                document.getElementById('air_humidity').value = airHumidity;
                document.getElementById('tds').value = tds;

                highlightUpdatedFields();
                showNotification('Sensor data received', 'success');
                setStatus(MSGS.statusConnected, true);

                btReadBtn.disabled = false;
                btReadBtn.innerHTML = '<span class="btn-icon">üìä</span> ' + MSGS.btnRead;

                return;
            }

            if (typeof payload === 'string') {
                fillSensorFieldsFromCSV(payload);
            }
        } catch (err) {
            console.error('onSensorData parse error', err, payload);
        }
    };

    if (isAndroidApp) {
        console.log('Running inside Android WebView - using native BLE');

        btConnectBtn.onclick = function() {
            try {
                AndroidNative.startScan();
                setStatus(MSGS.statusScanning);
                btConnectBtn.innerHTML = '<span class="btn-icon">üîç</span> ' + MSGS.statusScanning;
                btConnectBtn.disabled = true;
                showNotification('Scanning for sensor...', 'info');
            } catch (e) {
                console.error('AndroidNative.startScan error', e);
                showNotification('Native BLE unavailable', 'error');
            }
        };

        btReadBtn.onclick = function() {
            try {
                AndroidNative.readNow();
                setStatus(MSGS.readWait);
                btReadBtn.innerHTML = '<span class="btn-icon">‚è≥</span> ' + MSGS.readWait;
                btReadBtn.disabled = true;
            } catch (e) {
                console.error('AndroidNative.readNow error', e);
                showNotification('Native read not available', 'error');
            }
        };

    } else {
        btConnectBtn.addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) {
                    showNotification("Web Bluetooth is not supported in this browser. Use Chrome or Edge.", "error");
                    return;
                }

                setStatus('Searching...');
                btConnectBtn.innerHTML = '<span class="btn-icon">üîç</span> ' + MSGS.statusScanning;
                btConnectBtn.disabled = true;

                btDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'NRSC_SoilMonitor' }],
                    optionalServices: [SERVICE_UUID]
                });

                btDevice.addEventListener('gattserverdisconnected', () => {
                    soilCharacteristic = null;
                    btReadBtn.disabled = true;
                    setStatus(MSGS.statusNotConnected);
                    showNotification(MSGS.sensorFail, 'warning');
                });

                setStatus('Connecting...');
                btConnectBtn.disabled = true;

                const server = await btDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                soilCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                btReadBtn.disabled = false;
                setStatus(MSGS.statusConnected, true);
                btConnectBtn.innerHTML = '<span class="btn-icon">‚úÖ</span> ' + MSGS.statusConnected;
                showNotification(MSGS.sensorConnect, 'success');

                try {
                    await soilCharacteristic.startNotifications();
                    soilCharacteristic.addEventListener('characteristicvaluechanged', event => {
                        const value = event.target.value;
                        const decoder = new TextDecoder('utf-8');
                        const text = decoder.decode(value);
                        fillSensorFieldsFromCSV(text);
                        showNotification('Sensor data received automatically!', 'success');
                    });
                } catch (e) {
                    console.warn('Notifications not supported, using manual read');
                }

            } catch (err) {
                console.error('Bluetooth error:', err);
                if (err.name === 'NotFoundError') {
                    showNotification('No NRSC soil sensor found nearby', 'error');
                } else {
                    showNotification(MSGS.sensorFail, 'error');
                }
                setStatus(MSGS.statusNotConnected);
                btConnectBtn.innerHTML = '<span class="btn-icon">üì±</span> ' + MSGS.btnConnect;
                btConnectBtn.disabled = false;
            }
        });

        btReadBtn.addEventListener('click', async () => {
            if (!soilCharacteristic) {
                showNotification('Sensor not connected yet.', 'error');
                return;
            }

            try {
                setStatus(MSGS.readWait);
                btReadBtn.innerHTML = '<span class="btn-icon">‚è≥</span> ' + MSGS.readWait;
                btReadBtn.disabled = true;

                const value = await soilCharacteristic.readValue();
                const decoder = new TextDecoder('utf-8');
                const text = decoder.decode(value);

                fillSensorFieldsFromCSV(text);
                setStatus(MSGS.statusConnected, true);
                showNotification('Readings updated!', 'success');

            } catch (err) {
                console.error('Read error:', err);
                showNotification('Error reading: ' + err.message, 'error');
                setStatus('Read failed', true);
            } finally {
                btReadBtn.innerHTML = '<span class="btn-icon">üìä</span> ' + MSGS.btnRead;
                btReadBtn.disabled = false;
            }
        });
    }

    function fillSensorFieldsFromCSV(csvText) {
        const parts = csvText.trim().split(',');

        const [
            n, p, k, ec,
            soilTemp, ph, moisture,
            airTemp, airHumidity, tds
        ] = parts;

        document.getElementById('soil_n').value = n ?? "";
        document.getElementById('soil_p').value = p ?? "";
        document.getElementById('soil_k').value = k ?? "";
        document.getElementById('ec').value = ec ?? "";
        document.getElementById('soil_temp').value = soilTemp ?? "";
        document.getElementById('ph').value = ph ?? "";
        document.getElementById('soil_moisture').value = moisture ?? "";
        document.getElementById('air_temp').value = airTemp ?? "";
        document.getElementById('air_humidity').value = airHumidity ?? "";
        document.getElementById('tds').value = tds ?? "";

        highlightUpdatedFields();
    }

    function highlightUpdatedFields() {
        const fields = ['soil_n', 'soil_p', 'soil_k', 'ec', 'soil_temp', 'ph', 'soil_moisture', 'air_temp', 'air_humidity', 'tds'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.style.backgroundColor = '#e8f5e8';
            field.style.borderColor = '#27ae60';
            setTimeout(() => {
                field.style.backgroundColor = '';
                field.style.borderColor = '';
            }, 2000);
        });
    }

    // ================== SAVE / RESET READINGS ==================
    const btnSave = document.getElementById('btnSaveReading');
    const btnReset = document.getElementById('btnResetReadings');

    btnSave.addEventListener('click', async () => {
        const payload = {
            soil_n: parseFloat(document.getElementById('soil_n').value) || 0,
            soil_p: parseFloat(document.getElementById('soil_p').value) || 0,
            soil_k: parseFloat(document.getElementById('soil_k').value) || 0,
            ec: parseFloat(document.getElementById('ec').value) || 0,
            soil_temp: parseFloat(document.getElementById('soil_temp').value) || 0,
            ph: parseFloat(document.getElementById('ph').value) || 0,
            soil_moisture: parseFloat(document.getElementById('soil_moisture').value) || 0,
            air_temp: parseFloat(document.getElementById('air_temp').value) || 0,
            air_humidity: parseFloat(document.getElementById('air_humidity').value) || 0,
            tds: parseFloat(document.getElementById('tds').value) || 0
        };

        const hasData = Object.values(payload).some(val => val > 0);
        if (!hasData) {
            showNotification('Please enter sensor readings first.', 'warning');
            return;
        }

        try {
            btnSave.innerHTML = '<span class="btn-icon">‚è≥</span> Saving...';
            btnSave.disabled = true;

            const resp = await fetch(saveReadingUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const data = await resp.json();
            if (!data.ok) {
                throw new Error(data.error || 'Server error');
            }

            currentReadingCount = data.count;
            showNotification(MSGS.readingSaved, 'success');

            clearSensorFields();
            btnSave.innerHTML = `<span class="btn-icon">üíæ</span> ${MSGS.btnSaveReading} (${data.count + 1})`;

            updateGenerateButtonState();
            updateProgressUI();

        } catch (err) {
            console.error('Save error:', err);
            showNotification('Error saving: ' + err.message, 'error');
        } finally {
            btnSave.disabled = false;
        }
    });

    btnReset.addEventListener('click', async () => {
        if (!confirm(MSGS.resetConfirm)) {
            return;
        }

        try {
            btnReset.innerHTML = '<span class="btn-icon">‚è≥</span> Resetting...';
            btnReset.disabled = true;
            
            const resp = await fetch(resetReadingsUrl, { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await resp.json();
            
            if (!data.ok) {
                throw new Error(data.error || 'Server error');
            }

            clearSensorFields();
            currentReadingCount = 0;
            updateGenerateButtonState();
            updateProgressUI();

            showNotification('Readings cleared!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);

        } catch (err) {
            console.error('Reset error:', err);
            showNotification('Error: ' + err.message, 'error');
        } finally {
            btnReset.innerHTML = '<span class="btn-icon">üîÑ</span> ' + MSGS.btnResetReadings;
            btnReset.disabled = false;
        }
    });

    function clearSensorFields() {
        const fields = ['soil_n', 'soil_p', 'soil_k', 'ec', 'soil_temp', 'ph', 'soil_moisture', 'air_temp', 'air_humidity', 'tds'];
        fields.forEach(id => {
            document.getElementById(id).value = '';
        });
    }

    // NEW: Generate Report button handler
    btnGenerate.addEventListener('click', () => {
        if (currentReadingCount < maxReadings) {
            showNotification(`Please complete at least ${maxReadings} readings.`, 'warning');
            return;
        }
        window.location.href = "{{ url_for('calculate') }}";
    });

    // Notification system
    function showNotification(message, type = 'info') {
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notif => notif.remove());

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Initialize button states
    document.addEventListener('DOMContentLoaded', function() {
        btReadBtn.disabled = true;
        updateGenerateButtonState();
        updateProgressUI();
    });
</script>
{% endblock %}
