{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>Crop & Soil Details</h2>

    <form method="post" class="form-grid" id="cropForm">
        <!-- 1. GPS: fetched via browser, not typed -->
        <label>GPS Enabled Location (coordinates)
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <input type="text" id="gps_location" name="gps_location"
                       value="{{ crop.get('gps_location', '') }}"
                       placeholder="Latitude, Longitude"
                       readonly style="flex:1 1 auto;">
                <button type="button" id="getLocationBtn" class="secondary-btn">
                    Get GPS
                </button>
            </div>
        </label>

        <!-- 2. Full address from coordinates -->
        <label>Full Address of Location
            <textarea id="gps_address" name="gps_address" rows="2" readonly
                      placeholder="Address will appear here after GPS is fetched">{{ crop.get('gps_address', '') }}</textarea>
        </label>

        <!-- 3. Soil type -->
        <label>Soil Type (Telangana)
            <select name="soil_type" required>
                <option value="">Select Soil Type</option>
                {% for soil in telangana_soils %}
                    <option value="{{ soil }}"
                        {% if crop.get('soil_type') == soil %}selected{% endif %}>
                        {{ soil }}
                    </option>
                {% endfor %}
            </select>
        </label>

        <!-- 4. Crop -->
        <label>Crop
            <select name="crop" id="cropSelect" required>
                <option value="">Select Crop</option>
                {% for c in crops %}
                    <option value="{{ c }}"
                        {% if crop.get('crop') == c %}selected{% endif %}>
                        {{ c }}
                    </option>
                {% endfor %}
            </select>
        </label>

        <!-- 5. Variety -->
        <label>Variety of crop
            <select name="variety" id="varietySelect" required>
                <option value="">Select Variety</option>
            </select>
        </label>

        <!-- 6. Season -->
        <label>Season
            <input type="text" id="season" value="{{ crop.get('season', '') }}" readonly>
        </label>

        <!-- 7. Crop Duration -->
        <label>Crop Duration (days)
            <input type="number" name="duration" id="duration"
                   min="0" value="{{ crop.get('duration', '') }}" readonly>
        </label>

        <!-- 8. Recommended NPK from Excel -->
        <label>Recommended N:P:K (kg/ha)
            <input type="text" name="recommended_npk" id="recommended_npk"
                   value="{{ crop.get('recommended_npk', '') }}" readonly>
        </label>

        <!-- 9. Farmer actual land area -->
        <label>Farmer Field / Land Area (ha)
            <input type="number" step="0.01" min="0" name="land_area"
                   value="{{ crop.get('land_area', '') }}">
        </label>

        <!-- 10. Target yield in q/ha -->
        <label>Target yield for STCR (q/ha)
            <input type="number" step="0.1" name="target_yield_q"
                   value="{% if crop.get('target_yield_q') is not none %}{{ crop.get('target_yield_q') }}{% endif %}">
            <small>If left blank, default target yield from STCR file (converted from t/ha) will be used.</small>
        </label>

        <!-- 11. Date of sowing -->
        <label>Select the Date of Sowing
            <input type="date" name="sowing_date"
                   value="{{ crop.get('sowing_date', '') }}" required>
        </label>

        <button type="submit" class="primary-btn">PROCEED TO TEST SOIL</button>
    </form>
</div>

<script>
// ---------- 1. Data from backend ----------
const cropVarietyMap = {{ crop_variety_map|tojson|safe }};
const cropInfoUrl = "{{ url_for('crop_info_api') }}";
const initialCrop = "{{ crop.get('crop', '') }}";
const initialVariety = "{{ crop.get('variety', '') }}";
const initialAddress = `{{ crop.get('gps_address', '') }}`;

// ---------- 2. Dynamic GPS location + reverse geocoding ----------
document.getElementById('getLocationBtn').addEventListener('click', function (e) {
    e.preventDefault();
    if (!navigator.geolocation) {
        alert("Geolocation is not supported by this browser.");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        function (pos) {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            document.getElementById('gps_location').value = lat + ", " + lon;
            fetchAddressFromCoords(lat, lon);
        },
        function (err) {
            alert("Unable to fetch location: " + err.message);
        }
    );
});

function fetchAddressFromCoords(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
    fetch(url, {
        headers: {
            "Accept": "application/json"
        }
    })
        .then(resp => resp.json())
        .then(data => {
            const addr = data.display_name || "";
            document.getElementById('gps_address').value = addr;
        })
        .catch(err => {
            console.error(err);
        });
}

// ---------- 3. Populate varieties based on crop ----------
const cropSelect = document.getElementById('cropSelect');
const varietySelect = document.getElementById('varietySelect');

function populateVarieties(cropName, selectedVariety) {
    varietySelect.innerHTML = "";
    const optDefault = document.createElement('option');
    optDefault.value = "";
    optDefault.textContent = "Select Variety";
    varietySelect.appendChild(optDefault);

    if (!cropName || !cropVarietyMap[cropName]) return;

    cropVarietyMap[cropName].forEach(function (v) {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        if (selectedVariety && selectedVariety === v) {
            opt.selected = true;
        }
        varietySelect.appendChild(opt);
    });
}

cropSelect.addEventListener('change', function () {
    populateVarieties(this.value, null);
    document.getElementById('season').value = "";
    document.getElementById('duration').value = "";
    document.getElementById('recommended_npk').value = "";
});

// ---------- 4. Fetch season/duration/NPK once variety is chosen ----------
function fetchCropInfo() {
    const crop = cropSelect.value;
    const variety = varietySelect.value;
    if (!crop || !variety) return;

    const url = cropInfoUrl + "?crop=" + encodeURIComponent(crop) +
                "&variety=" + encodeURIComponent(variety);

    fetch(url)
        .then(resp => {
            if (!resp.ok) throw new Error("No data found");
            return resp.json();
        })
        .then(data => {
            if (!data.ok) return;
            document.getElementById('season').value = data.season || "";
            document.getElementById('duration').value = data.duration || "";
            document.getElementById('recommended_npk').value = data.recommended_npk || "";
        })
        .catch(err => {
            console.error(err);
        });
}

varietySelect.addEventListener('change', fetchCropInfo);

// ---------- 5. On page load ----------
window.addEventListener('DOMContentLoaded', function () {
    if (initialCrop) {
        populateVarieties(initialCrop, initialVariety || null);
        if (initialVariety) {
            fetchCropInfo();
        }
    }
    if (initialAddress) {
        document.getElementById('gps_address').value = initialAddress;
    }
});
</script>
{% endblock %}
